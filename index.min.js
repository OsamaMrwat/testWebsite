const express=require("express"),expressLayout=require("express-ejs-layouts");require("dotenv").config();const bodyParser=require("body-parser"),nodemailer=require("nodemailer"),upload=require("express-fileupload"),sgMail=require("@sendgrid/mail");sgMail.setApiKey(process.env.SENDGRID_API_KEY);var butter=require("buttercms")(process.env.BUTTER_KEY);const fetch=require("node-fetch"),cors=require("cors"),app=express(),fs=require("fs"),PORT=process.env.PORT||8080;var xFrameOptions=require("x-frame-options");app.use(xFrameOptions()),app.use(cors());const evestRoutes=require("./routes/evest"),tradingplatform=require("./routes/tradingPlatforms"),startTrading=require("./routes/startTrading"),arabicRouting=require("./routes/arabicRouting"),spainshRouting=require("./routes/spainshRouting"),marketsRouting=require("./routes/marketsRouting"),productsRouting=require("./routes/productsRouting");app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.set("views","./views"),app.set("view engine","ejs"),app.use(expressLayout),app.use(upload()),app.use(express.static("public")),app.use("/css",express.static(__dirname+"/public/css")),app.use("/images",express.static(__dirname+"/public/images")),app.use("/fonts",express.static(__dirname+"/public/fonts")),app.use("/js",express.static(__dirname+"/public/js")),app.use("/node_modules",express.static(__dirname+"/node_modules")),app.use("/trade-room",express.static(__dirname+"/public/trade-room")),app.use("/legal",express.static(__dirname+"/public/legal"));const axios=require("axios");async function getPostSiteMaps(){let all_links=[];for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/posts?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/posts?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});let sitemap_entries,sitemap=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${all_links.map(link=>`\n<url><loc>https://www.evest.com/${link}</loc></url>`).join("")}\n</urlset>`;fs.writeFile("./public/post-sitemap.xml",sitemap,(function(err){if(err)throw err;console.log("File is created successfully.")}))}async function getPagesSiteMaps(){let all_links=[];for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/pages?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/pages?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});let sitemap_entries,sitemap=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${all_links.map(link=>`\n<url><loc>https://www.evest.com/${link}</loc></url>`).join("")}\n</urlset>`;fs.writeFile("./public/page-sitemap.xml",sitemap,(function(err){if(err)throw err;console.log("File is created successfully.")}))}async function getCategoriesSiteMaps(){let all_links=[];for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/categories?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/categories?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});let sitemap_entries,sitemap=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${all_links.map(link=>`\n<url><loc>https://www.evest.com/${link}</loc></url>`).join("")}\n</urlset>`;fs.writeFile("./public/category-sitemap.xml",sitemap,(function(err){if(err)throw err;console.log("File is created successfully.")}))}async function getTagsSiteMaps(){let all_links=[];for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/tags?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/tags?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});let sitemap_entries,sitemap=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${all_links.map(link=>`\n<url><loc>https://www.evest.com/${link}</loc></url>`).join("")}\n</urlset>`;fs.writeFile("./public/post_tag-sitemap.xml",sitemap,(function(err){if(err)throw err;console.log("File is created successfully.")}))}async function getCommoditiesSiteMaps(){let all_links=[];for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/commodities?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});for(let page=1;page<10;page++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/commodities?page=${page}&per_page=100`).then(res=>{for(let ele in res.data)all_links.push(res.data[ele].link.substring(22))}).catch(error=>{});let sitemap_entries,sitemap=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${all_links.map(link=>`\n<url><loc>https://www.evest.com/${link}</loc></url>`).join("")}\n</urlset>`;fs.writeFile("./public/commodities-sitemap.xml",sitemap,(function(err){if(err)throw err;console.log("File is created successfully.")}))}getPostSiteMaps(),getPagesSiteMaps(),getCategoriesSiteMaps(),getTagsSiteMaps(),getCommoditiesSiteMaps();const SitemapGenerator=require("sitemap-generator"),generator=SitemapGenerator("http://www.evest.com",{maxDepth:0,filepath:"./public/sitemap.xml",maxEntriesPerFile:5e4,stripQuerystring:!0});generator.on("done",()=>{}),generator.start();const myapi=require("./pricesAPI");app.get("/stocks",(req,res)=>{res.send(myapi.getStocks)}),app.get("/currency",(req,res)=>{res.send(myapi.getCurrency)}),app.get("/commodities",(req,res)=>{res.send(myapi.getCommodities)}),app.get("/indices",(req,res)=>{res.send(myapi.getIndices)}),app.get("/crypto",(req,res)=>{res.send(myapi.getCrypto)}),app.get("/",(req,res)=>{res.get("X-Frame-Options"),butter.page.retrieve("*","homepage-en").then((function(resp){var page1=resp.data.data;res.render("index",{page:page1})}))}),app.get("/ceo",(req,res)=>{butter.page.retrieve("*","meet-ceo").then((function(resp){var page1=resp.data.data;res.render("ceo",{page:page1})})).catch((function(resp){console.log(resp)}))}),app.get("/trade-room",(req,res)=>{res.sendFile(__dirname+"/public/trade-room/static.html")}),app.get("/mobile",(req,res)=>{res.sendFile(__dirname+"/public/mobile/index.html")}),app.get("/trading-academy/:loginStatus",(req,res)=>{butter.page.retrieve("*","trading-academy").then((function(resp){var page1=resp.data.data;"true"==req.params.loginStatus?res.render("tradingAcademyLoggedin",{page:page1}):res.render("tradingAcademy",{page:page1})})).catch((function(resp){console.log(resp)}))}),app.get("/trading-academy",(req,res)=>{butter.page.retrieve("*","trading-academy").then((function(resp){var page1=resp.data.data;res.render("tradingAcademy",{page:page1})})).catch((function(resp){console.log(resp)}))}),app.get("/faq",(req,res)=>{butter.page.retrieve("*","faq").then((function(resp){var page1=resp.data.data;res.render("faq",{page:page1})})).catch((function(resp){console.log(resp)}))}),app.get("/oil-news",(req,res)=>{var page={fields:{seo:{meta_description:"Oil news, stay up to date with the latest updates with Evest on the latest Oil news and updates including the economy, the stock",meta_keywords:"Oil News",page_title:"Oil News - Evest latest updates and news about oil trading"}}};res.render("Education/oil",{page:page})}),app.get("/oil-news/:slug",async(req,res)=>{const url=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${req.params.slug}`,options={method:"GET"},response=await fetch(url,options).then(res=>res.json()).then(data=>{var article=data;const data_tags=Object.keys(data[0].yoast_head_json.schema).map((function(key){return data[0].yoast_head_json.schema[key]})),tags=data_tags[1][5]?data_tags[1][5].keywords.map(tag=>`<a class="badge bg-secondary text-decoration-none link-light" href="#!">${tag}</a>`).join(" "):" ";var page={fields:{seo:{meta_description:`${article[0].yoast_head_json.og_description}`,meta_keyword:`${data_tags[1][5].keywords}`,page_title:`${article[0].yoast_head_json.og_title}`}}};res.render("Education/article",{page:page,content:article[0].content.rendered,titleArticle:article[0].title.rendered,imgUrl:article[0].featured_image_url,date:article[0].date,url:article[0].link,tags:tags,og_img:`${article[0].yoast_head_json.og_image.url}`})}).catch(err=>console.log(err))}),app.get("/gold-news",(req,res)=>{var page={fields:{seo:{meta_description:"Gold trading news, stay up to date with the latest updates with Evest on the latest gold news and economy, stock, share market online",meta_keywords:"Gold News",page_title:"Gold Trading News - Evest latest news and updates on gold trading"}}};res.render("Education/gold",{page:page})}),app.get("/gold-news/:slug",async(req,res)=>{const url=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${req.params.slug}`,options={method:"GET"},response=await fetch(url,options).then(res=>res.json()).then(data=>{var article=data;const data_tags=Object.keys(data[0].yoast_head_json.schema).map((function(key){return data[0].yoast_head_json.schema[key]})),tags=data_tags[1][5]?data_tags[1][5].keywords.map(tag=>`<a class="badge bg-secondary text-decoration-none link-light" href="#!">${tag}</a>`).join(" "):" ";var page={fields:{seo:{meta_description:`${article[0].yoast_head_json.og_description}`,meta_keyword:`${data_tags[1][5].keywords}`,page_title:`${article[0].yoast_head_json.og_title}`}}};res.render("Education/article",{page:page,content:article[0].content.rendered,titleArticle:article[0].title.rendered,imgUrl:article[0].featured_image_url,date:article[0].date,url:article[0].link,tags:tags,og_img:`${article[0].yoast_head_json.og_image.url}`})}).catch(err=>console.log(err))}),app.get("/market-news",(req,res)=>{var page={fields:{seo:{meta_description:"Stock market news, stay up to date with the latest updates with Evest on the economy stock market and share market, ٍstock news",meta_keywords:"Stock Market News",page_title:"Stock Market News - Evest latest financial news and updates"}}};res.render("Education/gold",{page:page})}),app.get("/market-news/:slug",async(req,res)=>{const url=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${req.params.slug}`,options={method:"GET"},response=await fetch(url,options).then(res=>res.json()).then(data=>{var article=data;const data_tags=Object.keys(data[0].yoast_head_json.schema).map((function(key){return data[0].yoast_head_json.schema[key]})),tags=data_tags[1][5]?data_tags[1][5].keywords.map(tag=>`<a class="badge bg-secondary text-decoration-none link-light" href="#!">${tag}</a>`).join(" "):" ";var page={fields:{seo:{meta_description:`${article[0].yoast_head_json.og_description}`,meta_keyword:`${data_tags[1][5].keywords}`,page_title:`${article[0].yoast_head_json.og_title}`}}};res.render("Education/article",{page:page,content:article[0].content.rendered,titleArticle:article[0].title.rendered,imgUrl:article[0].featured_image_url,date:article[0].date,url:article[0].link,tags:tags,og_img:`${article[0].yoast_head_json.og_image.url}`})}).catch(err=>console.log(err))}),app.get("/trading-news",(req,res)=>{var page={fields:{seo:{meta_description:"Trading News, Get the latest Trading News of the market now from anywhere in the world directly to you! Top and latest news about stock market",meta_keywords:"Trading News",page_title:"Trading News - Evest Top and latest news about stock market"}}};res.render("Education/tradingNews",{page:page})}),app.get("/trading-news/:slug",async(req,res)=>{const url=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${req.params.slug}`,options={method:"GET"},response=await fetch(url,options).then(res=>res.json()).then(data=>{var article=data;const data_tags=Object.keys(data[0].yoast_head_json.schema).map((function(key){return data[0].yoast_head_json.schema[key]})),tags=data_tags[1][5]?data_tags[1][5].keywords.map(tag=>`<a class="badge bg-secondary text-decoration-none link-light" href="#!">${tag}</a>`).join(" "):" ";var page={fields:{seo:{meta_description:`${article[0].yoast_head_json.og_description}`,meta_keyword:`${data_tags[1][5].keywords}`,page_title:`${article[0].yoast_head_json.og_title}`}}};res.render("Education/article",{page:page,content:article[0].content.rendered,titleArticle:article[0].title.rendered,imgUrl:article[0].featured_image_url,date:article[0].date,url:article[0].link,tags:tags,og_img:`${article[0].yoast_head_json.og_image.url}`})}).catch(err=>console.log(err))}),app.post("/send",(req,res)=>{const msg={to:"support@evest.com",from:"no-replay@customers-evest.com",subject:`${req.body.email} Send You New Message from the CEO website page`,html:`  <h1>You Got New Message</h1>\n    <p>EMAIL: ${req.body.email}.<br><br>\n    FULL NAME: ${req.body.fullName}.<br><br>\n    SUBJECT: ${req.body.subject}.<br><br>\n    MESSAGE: ${req.body.message}.<br></p>`,replyTo:`${req.body.email}`};sgMail.send(msg).then(()=>{},error=>{console.error(error),error.response&&console.error(error.response.body)}),res.render("Evest/contactUs",{title:"Contact Us - Evest Trading Platform, 0% commission fees",description:"Contact Us: Submit a request below, and one of our support professionals will happily get back to you. Got Questions? We're here to help!",keywords:"Contact us",message:"Message Sent Thank You,We will contact you soon ."})}),app.post("/ceo",(req,res)=>{const msg={to:"ceo@evest.com",from:'"CEO Page"<no-replay@customers-evest.com>',subject:` ${req.body.email} Send You New Message from the CEO website page`,html:`  <h1>You Got New Message</h1>\n    <p>EMAIL: ${req.body.email}.<br><br>\n    FULL NAME: ${req.body.fullName}.<br><br>\n    SUBJECT: ${req.body.subject}.<br><br>\n    MESSAGE: ${req.body.message}.<br></p>`,replyTo:`${req.body.email}`};sgMail.send(msg).then(()=>{},error=>{console.error(error),error.response&&console.error(error.response.body)}),res.render("ceo",{title:"Meet The CEO",description:"sent",keywords:""})}),app.use("/evest",evestRoutes),app.use("/",tradingplatform),app.use("/start-trading",startTrading),app.use("/markets",marketsRouting),app.use("/trading-products",productsRouting),app.use("/ar",arabicRouting),app.use("/es",spainshRouting),app.get("/upload",(req,res)=>{const reject=()=>{res.setHeader("www-authenticate","Basic"),res.sendStatus(401)},authorization=req.headers.authorization;if(!authorization)return reject();const[username,password]=Buffer.from(authorization.replace("Basic ",""),"base64").toString().split(":");if("admin"!==username||"q53hh=-Y5Sat?vUj"!==password)return reject();res.render("upload",{title:"Upload files",description:"",keywords:""})}),app.post("/upload",(req,res)=>{if(req.files){var file=req.files.file,filename=file.name;file.mv("./public/legal/"+filename,(function(err){err?res.send(err):res.send("File Uploaded")}))}}),app.get("*",(req,res)=>{res.redirect("/")}),app.listen(PORT,()=>{console.log(`server start on PORT:${PORT}`)});