async function getPostSiteMaps(){let e=[];for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/posts?page=${t}&per_page=100`).then(t=>{for(let a in t.data)t.data[a].link.includes("commodities")||e.push(t.data[a].link.substring(22))}).catch(e=>{});for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/posts?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});let t=e.map(e=>`\n<url><loc>https://www.evest.com/${e}</loc></url>`),a=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${t.join("")}\n</urlset>`;fs.writeFile("./public/post-sitemap.xml",a,function(e){var t=new Date,a=t.getFullYear(),s=t.getMonth()+1,r=t.getDate(),o=t.getHours(),i=t.getMinutes(),n=t.getSeconds(),c=a+"-"+s+"-"+r+" "+o+":"+i+":"+n;if(e)throw e;fs.appendFile("./public/logForPost.txt",`${c} - Post Sitemap -File is created successfully`,function(e){if(e)throw e;console.log(`${c} - Log File is created successfully`)})})}async function getPagesSiteMaps(){let e=[];for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/pages?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/pages?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});let t=e.map(e=>`\n<url><loc>https://www.evest.com/${e}</loc></url>`),a=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${t.join("")}\n</urlset>`;fs.writeFile("./public/page-sitemap.xml",a,function(e){if(e)throw e;console.log("File is created successfully.")})}async function getCategoriesSiteMaps(){let e=[];for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/categories?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/categories?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});let t=e.map(e=>`\n<url><loc>https://www.evest.com/${e}</loc></url>`),a=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${t.join("")}\n</urlset>`;fs.writeFile("./public/category-sitemap.xml",a,function(e){if(e)throw e;console.log("File is created successfully.")})}async function getTagsSiteMaps(){let e=[];for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/tags?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/tags?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});let t=e.map(e=>`\n<url><loc>https://www.evest.com/${e}</loc></url>`),a=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${t.join("")}\n</urlset>`;fs.writeFile("./public/post_tag-sitemap.xml",a,function(e){if(e)throw e;console.log("File is created successfully.")})}async function getCommoditiesSiteMaps(){let e=[];for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/wp-json/wp/v2/commodities?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});for(let t=1;t<10;t++)await axios.get(`https://cms.evest.com/ar/wp-json/wp/v2/commodities?page=${t}&per_page=100`).then(t=>{for(let a in t.data)e.push(t.data[a].link.substring(22))}).catch(e=>{});let t=e.map(e=>`\n<url><loc>https://www.evest.com/${e}</loc></url>`),a=`<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" \nxmlns:image="http://www.sitemaps.org/schemas/sitemap-image/1.1" \nxmlns:video="http://www.sitemaps.org/schemas/sitemap-video/1.1">${t.join("")}\n</urlset>`;fs.writeFile("./public/commodities-sitemap.xml",a,function(e){if(e)throw e;console.log("File is created successfully.")})}function validateRequestOnRTIServer(e,t){return new Promise((a,s)=>{const r={ApiKey:config.apiKey,TagHash:config.tagHash,ClientIP:t.ip,RequestURL:`${t.protocol}://${t.get("host")}${t.originalUrl}`,ResourceType:t.headers["content-type"]||t.headers["Content-Type"],Method:t.method,Host:t.headers.host||t.headers.Host,UserAgent:t.headers["user-agent"]||t.headers["User-Agent"],Accept:t.headers.accept||t.headers.Accept,AcceptLanguage:t.headers["accept-language"]||t.headers["Accept-Language"],AcceptEncoding:t.headers["accept-encoding"]||t.headers["Accept-Encoding"],HeaderNames:"Host,User-Agent,Accept,Accept-Langauge,Accept-Encoding,Cookie",CheqCookie:t.cookies._cheq_rti,EventType:e};console.log(JSON.stringify(r)),request.post({url:config.cheqsEngineUri,headers:{"Content-Type":"application/x-www-form-urlencoded"},form:r},(e,t)=>{if(console.log(t),e)return s(e);try{a(JSON.parse(t.body))}catch(e){console.error(e),a()}})})}const express=require("express"),expressLayout=require("express-ejs-layouts");require("dotenv").config();const bodyParser=require("body-parser"),nodemailer=require("nodemailer"),upload=require("express-fileupload"),sgMail=require("@sendgrid/mail");sgMail.setApiKey(process.env.SENDGRID_API_KEY);var butter=require("buttercms")(process.env.BUTTER_KEY);const fetch=require("node-fetch"),cors=require("cors"),{ToadScheduler:ToadScheduler,SimpleIntervalJob:SimpleIntervalJob,Task:Task}=require("toad-scheduler"),helmet=require("helmet"),config=require("./config"),cookieParser=require("cookie-parser"),request=require("request"),app=express();app.use(require("express-status-monitor")()),app.use(cookieParser());const fs=require("fs"),PORT=process.env.PORT||8080;var xFrameOptions=require("x-frame-options");app.use(xFrameOptions()),app.use(cors());const evestRoutes=require("./routes/evest"),tradingplatform=require("./routes/tradingPlatforms"),startTrading=require("./routes/startTrading"),arabicRouting=require("./routes/arabicRouting"),spainshRouting=require("./routes/spainshRouting"),marketsRouting=require("./routes/marketsRouting"),productsRouting=require("./routes/productsRouting");app.use(helmet.frameguard({action:"sameorigin"})),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.set("views","./views"),app.set("view engine","ejs"),app.use(expressLayout),app.use(upload()),app.use(express.static("public")),app.use("/css",express.static(__dirname+"/public/css")),app.use("/images",express.static(__dirname+"/public/images")),app.use("/fonts",express.static(__dirname+"/public/fonts")),app.use("/js",express.static(__dirname+"/public/js")),app.use("/node_modules",express.static(__dirname+"/node_modules")),app.use("/trade-room",express.static(__dirname+"/public/trade-room")),app.use("/legal",express.static(__dirname+"/public/legal")),app.use("/publicFiles",express.static(__dirname+"/public/publicFiles"));var count=0;const axios=require("axios");getPostSiteMaps(),getPagesSiteMaps(),getCategoriesSiteMaps(),getTagsSiteMaps(),getCommoditiesSiteMaps();const scheduler=new ToadScheduler,task=new Task("simple task",getPostSiteMaps),job=new SimpleIntervalJob({hours:2},task);scheduler.addSimpleIntervalJob(job);const SitemapGenerator=require("sitemap-generator"),generator=SitemapGenerator("http://www.evest.com",{maxDepth:0,filepath:"./public/sitemap.xml",maxEntriesPerFile:5e4,stripQuerystring:!0});generator.on("done",()=>{}),generator.start();const myapi=require("./pricesAPI");app.get("/stocks",(e,t)=>{t.send(myapi.getStocks)}),app.get("/currency",(e,t)=>{t.send(myapi.getCurrency)}),app.get("/commodities",(e,t)=>{t.send(myapi.getCommodities)}),app.get("/indices",(e,t)=>{t.send(myapi.getIndices)}),app.get("/crypto",(e,t)=>{t.send(myapi.getCrypto)}),app.get("/",async(e,t)=>{t.get("X-Frame-Options"),butter.page.retrieve("*","homepage-en").then(e=>{var a=e.data.data;t.render("index",{page:a,tagHash:config.tagHash})})}),app.get("/ceo",(e,t)=>{butter.page.retrieve("*","meet-ceo").then(function(e){var a=e.data.data;t.render("ceo",{page:a})}).catch(function(e){console.log(e)})}),app.get("/trade-room",(e,t)=>{t.sendFile(__dirname+"/public/trade-room/static.html")}),app.get("/mobile",(e,t)=>{t.sendFile(__dirname+"/public/mobile/index.html")}),app.get("/trading-academy/:loginStatus",(e,t)=>{butter.page.retrieve("*","trading-academy").then(function(a){var s=a.data.data;"true"==e.params.loginStatus?t.render("tradingAcademyLoggedin",{page:s}):t.render("tradingAcademy",{page:s})}).catch(function(e){console.log(e)})}),app.get("/trading-academy",(e,t)=>{butter.page.retrieve("*","trading-academy").then(function(e){var a=e.data.data;t.render("tradingAcademy",{page:a})}).catch(function(e){console.log(e)})}),app.get("/faq",(e,t)=>{butter.page.retrieve("*","faq").then(function(e){var a=e.data.data;t.render("faq",{page:a})}).catch(function(e){console.log(e)})}),app.get("/oil-news",async(e,t)=>{const a="https://cms.evest.com/wp-json/wp/v2/posts?_embed&categories=42&per_page=6&page=1",s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a={fields:{seo:{meta_description:"Oil news, stay up to date with the latest updates with Evest on the latest Oil news and updates including the economy, the stock",meta_keywords:"Oil News",page_title:"Oil News - Evest latest updates and news about oil trading"}}};const s=e.map(e=>{let t=e.date.split("T")[0];return`<div class="card">\n          <div> \n                <a href="${e.link}"> <img class="card-img-top" src="${e.featured_image_url}" alt="Card image cap"></a>\n<div class="card-body">\n<a href="${e.link}"><h5 class="card-title">${e.title.rendered}</h5></a>\n<div class="card-text description">${e.excerpt.rendered}</div>\n<a class="btn btn-filled readmore" href="${e.link}">Read more</a>\n</div></div>\n<div class="card-footer dateCreated">\n${t}\n</div>\n</div>`}).join("");t.render("Education/oil",{page:a,articles:s})})}),app.get("/oil-news/:slug",async(e,t)=>{const a=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${e.params.slug}`,s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a=e;const s=Object.keys(e[0].yoast_head_json.schema).map(function(t){return e[0].yoast_head_json.schema[t]}),r=s[1][5]?s[1][5].keywords.map(e=>`<a class="badge bg-secondary text-decoration-none link-light" href="/tag/${e}">${e}</a>`).join(" "):" ";var o={fields:{seo:{meta_description:`${a[0].yoast_head_json.og_description}`,meta_keyword:`${s[1][5].keywords}`,page_title:`${a[0].yoast_head_json.og_title}`}}};t.render("Education/article",{page:o,content:a[0].content.rendered,titleArticle:a[0].title.rendered,imgUrl:a[0].featured_image_url,date:a[0].date,url:a[0].link,tags:r,og_img:`${a[0].yoast_head_json.og_image.url}`})}).catch(e=>console.log(e))}),app.get("/gold-news",async(e,t)=>{const a="https://cms.evest.com/wp-json/wp/v2/posts?_embed&categories=41&per_page=6&page=1",s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a={fields:{seo:{meta_description:"Gold trading news, stay up to date with the latest updates with Evest on the latest gold news and economy, stock, share market online",meta_keywords:"Gold News",page_title:"Gold Trading News - Evest latest news and updates on gold trading"}}};const s=e.map(e=>{let t=e.date.split("T")[0];return`<div class="card">\n          <div> \n                 <a href="${e.link}"><img class="card-img-top" src="${e.featured_image_url}" alt="Card image cap"></a>\n<div class="card-body">\n<a hef="${e.link}"><h5 class="card-title">${e.title.rendered}</h5></a>\n<div class="card-text description">${e.excerpt.rendered}</div>\n<a class="btn btn-filled readmore" href="${e.link}">Read more</a>\n</div></div>\n<div class="card-footer dateCreated">\n${t}\n</div>\n</div>`}).join("");t.render("Education/gold",{page:a,articles:s})})}),app.get("/gold-news/:slug",async(e,t)=>{const a=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${e.params.slug}`,s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a=e;const s=Object.keys(e[0].yoast_head_json.schema).map(function(t){return e[0].yoast_head_json.schema[t]}),r=s[1][5]?s[1][5].keywords.map(e=>`<a class="badge bg-secondary text-decoration-none link-light" href="/tag/${e}">${e}</a>`).join(" "):" ";var o={fields:{seo:{meta_description:`${a[0].yoast_head_json.og_description}`,meta_keyword:`${s[1][5].keywords}`,page_title:`${a[0].yoast_head_json.og_title}`}}};t.render("Education/article",{page:o,content:a[0].content.rendered,titleArticle:a[0].title.rendered,imgUrl:a[0].featured_image_url,date:a[0].date,url:a[0].link,tags:r,og_img:`${a[0].yoast_head_json.og_image.url}`})}).catch(e=>console.log(e))}),app.get("/market-news",async(e,t)=>{const a="https://cms.evest.com/wp-json/wp/v2/posts?_embed&categories=46&per_page=6&page=1",s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a={fields:{seo:{meta_description:"Stock market news, stay up to date with the latest updates with Evest on the economy stock market and share market, Ùstock news",meta_keywords:"Stock Market News",page_title:"Stock Market News - Evest latest financial news and updates"}}};const s=e.map(e=>{let t=e.date.split("T")[0];return`<div class="card">\n          <div> \n              <a href="${e.link}"><img class="card-img-top" src="${e.featured_image_url}" alt="Card image cap"></a>\n<div class="card-body">\n<a href="${e.link}"><h5 class="card-title">${e.title.rendered}</h5></a>\n<div class="card-text description">${e.excerpt.rendered}</div>\n<a class="btn btn-filled readmore" href="${e.link}">Read more</a>\n</div></div>\n<div class="card-footer dateCreated">\n${t}\n</div>\n</div>`}).join("");t.render("Education/market",{page:a,articles:s})})}),app.get("/market-news/:slug",async(e,t)=>{const a=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${e.params.slug}`,s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a=e;const s=Object.keys(e[0].yoast_head_json.schema).map(function(t){return e[0].yoast_head_json.schema[t]}),r=s[1][5]?s[1][5].keywords.map(e=>`<a class="badge bg-secondary text-decoration-none link-light" href="/tag/${e}">${e}</a>`).join(" "):" ";var o={fields:{seo:{meta_description:`${a[0].yoast_head_json.og_description}`,meta_keyword:`${s[1][5].keywords}`,page_title:`${a[0].yoast_head_json.og_title}`}}};t.render("Education/article",{page:o,content:a[0].content.rendered,titleArticle:a[0].title.rendered,imgUrl:a[0].featured_image_url,date:a[0].date,url:a[0].link,tags:r,og_img:`${a[0].yoast_head_json.og_image.url}`})}).catch(e=>console.log(e))}),app.get("/trading-news",async(e,t)=>{const a="https://cms.evest.com/wp-json/wp/v2/posts?_embed&per_page=6&page=1",s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a={fields:{seo:{meta_description:"Trading News, Get the latest Trading News of the market now from anywhere in the world directly to you! Top and latest news about stock market",meta_keywords:"Trading News",page_title:"Trading News - Evest Top and latest news about stock market"}}};const s=e.map(e=>{let t=e.date.split("T")[0];return`<div class="card">\n          <div> \n                 <a href="${e.link}"><img class="card-img-top" src="${e.featured_image_url}" alt="Card image cap"></a>\n<div class="card-body">\n<a href="${e.link}"><h5 class="card-title">${e.title.rendered}</h5></a>\n<div class="card-text description">${e.excerpt.rendered}</div>\n<a class="btn btn-filled readmore" href="${e.link}">Read more</a>\n</div></div>\n<div class="card-footer dateCreated">\n${t}\n</div>\n</div>`}).join("");t.render("Education/tradingNews",{page:a,articles:s})})}),app.get("/trading-news/:slug",async(e,t)=>{const a=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&slug=${e.params.slug}`,s={method:"GET"};await fetch(a,s).then(e=>e.json()).then(e=>{var a=e;const s=Object.keys(e[0].yoast_head_json.schema).map(function(t){return e[0].yoast_head_json.schema[t]}),r=s[1][5]?s[1][5].keywords.map(e=>`<a class="badge bg-secondary text-decoration-none link-light" href="/tag/${e}">${e}</a>`).join(" "):" ";var o={fields:{seo:{meta_description:`${a[0].yoast_head_json.og_description}`,meta_keyword:`${s[1][5].keywords}`,page_title:`${a[0].yoast_head_json.og_title}`}}};t.render("Education/article",{page:o,content:a[0].content.rendered,titleArticle:a[0].title.rendered,imgUrl:a[0].featured_image_url,date:a[0].date,url:a[0].link,tags:r,og_img:`${a[0].yoast_head_json.og_image.url}`})}).catch(e=>console.log(e))}),app.post("/send",(e,t)=>{const a={to:"support@evest.com",from:"no-replay@customers-evest.com",subject:`${e.body.email} Send You New Message from the support website page`,html:`  <h1>You Got New Message</h1>\n    <p>EMAIL: ${e.body.email}.<br><br>\n    FULL NAME: ${e.body.fullName}.<br><br>\n    SUBJECT: ${e.body.subject}.<br><br>\n    MESSAGE: ${e.body.message}.<br></p>`,replyTo:`${e.body.email}`};sgMail.send(a).then(()=>{},e=>{console.error(e),e.response&&console.error(e.response.body)}),butter.page.retrieve("*","contact-us").then(function(e){var a=e.data.data;t.render("Evest/contactUs",{page:a,message:"Message Sent Thank You,We will contact you soon ."})}).catch(function(e){console.log(e)})}),app.post("/ceo",(e,t)=>{const a={to:"ceo@evest.com",from:'"CEO Page"<no-replay@customers-evest.com>',subject:` ${e.body.email} Send You New Message from the CEO website page`,html:`  <h1>You Got New Message</h1>\n    <p>EMAIL: ${e.body.email}.<br><br>\n    FULL NAME: ${e.body.fullName}.<br><br>\n    SUBJECT: ${e.body.subject}.<br><br>\n    MESSAGE: ${e.body.message}.<br></p>`,replyTo:`${e.body.email}`};sgMail.send(a).then(()=>{},e=>{console.error(e),e.response&&console.error(e.response.body)}),t.redirect("/ceo")});const getTag=require("./tagsApi");app.get("/tag/:tag",async(e,t)=>{const a=getTag.englishTags.find(t=>t.Name===e.params.tag).tag_id;console.log(+e.params.tag+" "+a),void 0===a&&t.redirect("/");const s=`https://cms.evest.com/wp-json/wp/v2/posts?_embed&tags=${a}&per_page=6&page=1`,r={method:"GET"};fetch(s,r).then(e=>e.json()).then(s=>{var r={fields:{seo:{meta_description:`Archive of ${e.params.tag}`,meta_keyword:`${e.params.tag}`,page_title:`Evest- ${e.params.tag} Archive`}}};const o=s.map(e=>{let t=e.date.split("T")[0];return`<div class="card">\n                    <div> \n                           <a href='${e.link}'>  <img class="card-img-top" src="${e.featured_image_url}" alt="Card image cap" title="${e.title.rendered}"> </a>\n        <div class="card-body">\n        <a href='${e.link}' ><h5 class="card-title">${e.title.rendered}</h5></a>\n        <div class="card-text description">${e.excerpt.rendered}</div>\n        <a class="btn btn-filled readmore" href='${e.link}'>read more</a>\n        </div></div>\n        <div class="card-footer dateCreated">\n        ${t}\n        </div>\n        </div>`}).join("");t.render("Education/tags",{page:r,articles:o,pageTitle:`Evest- ${e.params.tag} Archive`,tagId:a})}).catch(e=>{console.log("this is error from tag in index page"),t.redirect("/")})}),app.use("/evest",evestRoutes),app.use("/",tradingplatform),app.use("/start-trading",startTrading),app.use("/markets",marketsRouting),app.use("/trading-products",productsRouting),app.use("/ar",arabicRouting),app.use("/es",spainshRouting),app.get("/upload",(e,t)=>{const a=()=>{t.setHeader("www-authenticate","Basic"),t.sendStatus(401)},s=e.headers.authorization;if(!s)return a();const[r,o]=Buffer.from(s.replace("Basic ",""),"base64").toString().split(":");if("admin"!==r||"q53hh=-Y5Sat?vUj"!==o)return a();var i={fields:{seo:{meta_description:"",meta_keywords:"",page_title:"upload file to get public link"}}};t.render("upload",{page:i,link:""})}),app.post("/upload",(e,t)=>{if(e.files){var a=e.files.file,s=a.name;a.mv("./public/publicFiles/"+s,function(e){if(e)t.send(e);else{var a={fields:{seo:{meta_description:"",meta_keywords:"",page_title:"upload file to get public link"}}};t.render("upload",{page:a,link:`https://evest.com/publicFiles/${s}`})}})}}),app.get("/log",(e,t)=>{const a=()=>{t.setHeader("www-authenticate","Basic"),t.sendStatus(401)},s=e.headers.authorization;if(!s)return a();const[r,o]=Buffer.from(s.replace("Basic ",""),"base64").toString().split(":");if("admin"!==r||"q53hh=-Y5Sat?vUj"!==o)return a();t.sendFile(__dirname+"/public/logForPost.txt")}),app.get("*",(e,t)=>{t.redirect("/")}),app.listen(PORT,()=>{console.log(`server start on PORT:${PORT}`)});